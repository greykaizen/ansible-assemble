---
# Tasks for firewall_fortinet role
# Local-only firewall management using ufw (no external APIs or tokens).
# Reverts accidental misconfiguration (drift simulation).

- name: Check if ufw is installed
  command: which ufw
  register: ufw_check
  changed_when: false
  failed_when: false
  when: use_local_firewall

- name: Install ufw if not present
  apt:
    name: ufw
    state: present
  when: use_local_firewall and ufw_check.rc != 0

- name: Ensure ufw is enabled
  ufw:
    state: enabled
  when: use_local_firewall

- name: Allow Kubernetes API Server port (6443)
  ufw:
    rule: allow
    port: "{{ item.port }}"
    proto: "{{ item.protocol }}"
    comment: "{{ item.description }}"
  loop: "{{ k8s_required_ports }}"
  when: use_local_firewall

- name: Allow NodePort range (30000-32767)
  ufw:
    rule: allow
    port: "30000:32767"
    proto: tcp
    comment: "Kubernetes NodePort Services Range"
  when: use_local_firewall

- name: Check current ufw status
  command: ufw status numbered
  register: ufw_status
  changed_when: false
  when: use_local_firewall

- name: Display firewall rules
  debug:
    msg: "{{ ufw_status.stdout_lines }}"
  when: use_local_firewall

- name: Verify critical ports are accessible (simulation)
  debug:
    msg:
      - "Firewall rules verified for Kubernetes:"
      - "  ✓ Port 6443 (API Server) - ALLOWED"
      - "  ✓ Ports 30000-32767 (NodePort) - ALLOWED"
      - ""
      - "Drift remediation: Any blocked ports have been restored."

